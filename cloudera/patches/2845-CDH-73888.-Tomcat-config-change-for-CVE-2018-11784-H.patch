From 209a5ad989e442a4b842edc84589f4d346d23428 Mon Sep 17 00:00:00 2001
From: Kitti Nanasi <knanasi@cloudera.com>
Date: Thu, 11 Oct 2018 17:12:23 +0200
Subject: [PATCH 2845/2863] CDH-73888. Tomcat config change for CVE-2018-11784
 (Httpfs, KMS)

==C5_APPROVED_BUGFIX==

Change-Id: Ib02e5bb8f4ebe068e5e77549a56e33373f232c55
---
 .../hadoop-kms/src/main/tomcat/server.xml          |    3 +++
 .../hadoop-kms/src/main/tomcat/ssl-server.xml      |    3 +++
 .../hadoop-hdfs-httpfs/src/main/tomcat/server.xml  |    3 +++
 .../src/main/tomcat/ssl-server.xml                 |    3 +++
 4 files changed, 12 insertions(+)

diff --git a/hadoop-common-project/hadoop-kms/src/main/tomcat/server.xml b/hadoop-common-project/hadoop-kms/src/main/tomcat/server.xml
index 2b38425..df15def 100644
--- a/hadoop-common-project/hadoop-kms/src/main/tomcat/server.xml
+++ b/hadoop-common-project/hadoop-kms/src/main/tomcat/server.xml
@@ -137,6 +137,9 @@
       <Host name="localhost" appBase="webapps"
             unpackWARs="true" autoDeploy="true"
             xmlValidation="false" xmlNamespaceAware="false">
+        <Context path="/kms"
+                 mapperContextRootRedirectEnabled="true"
+                 mapperDirectoryRedirectEnabled="true" />
 
         <!-- SingleSignOn valve, share authentication between web applications
              Documentation at: /docs/config/valve.html -->
diff --git a/hadoop-common-project/hadoop-kms/src/main/tomcat/ssl-server.xml b/hadoop-common-project/hadoop-kms/src/main/tomcat/ssl-server.xml
index 6b63358..f2c748c 100644
--- a/hadoop-common-project/hadoop-kms/src/main/tomcat/ssl-server.xml
+++ b/hadoop-common-project/hadoop-kms/src/main/tomcat/ssl-server.xml
@@ -120,6 +120,9 @@
       <Host name="localhost" appBase="webapps"
             unpackWARs="true" autoDeploy="true"
             xmlValidation="false" xmlNamespaceAware="false">
+        <Context path="/kms"
+                 mapperContextRootRedirectEnabled="true"
+                 mapperDirectoryRedirectEnabled="true" />
 
         <!-- SingleSignOn valve, share authentication between web applications
              Documentation at: /docs/config/valve.html -->
diff --git a/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/server.xml b/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/server.xml
index 67f2159..792ce01 100644
--- a/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/server.xml
+++ b/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/server.xml
@@ -131,6 +131,9 @@
       <Host name="localhost" appBase="webapps"
             unpackWARs="true" autoDeploy="true"
             xmlValidation="false" xmlNamespaceAware="false">
+        <Context path="/webhdfs"
+                 mapperContextRootRedirectEnabled="true"
+                 mapperDirectoryRedirectEnabled="true" />
 
         <!-- SingleSignOn valve, share authentication between web applications
              Documentation at: /docs/config/valve.html -->
diff --git a/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/ssl-server.xml b/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/ssl-server.xml
index 408d4e3..3b02c0b 100644
--- a/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/ssl-server.xml
+++ b/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/tomcat/ssl-server.xml
@@ -118,6 +118,9 @@
       <Host name="localhost" appBase="webapps"
             unpackWARs="true" autoDeploy="true"
             xmlValidation="false" xmlNamespaceAware="false">
+        <Context path="/webhdfs"
+                 mapperContextRootRedirectEnabled="true"
+                 mapperDirectoryRedirectEnabled="true" />
 
         <!-- SingleSignOn valve, share authentication between web applications
              Documentation at: /docs/config/valve.html -->
-- 
1.7.9.5

